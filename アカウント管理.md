# 📝 アカウント設定バックエンド 実装計画書

## 🎯 目標
- ユーザー管理環境の構築
- ポイント管理システムの実装（有料購入 + 手動付与対応）
- 管理者機能の準備

## 📋 実装タスク一覧

### 1. データベーススキーマ設計・構築
-   [x] **現在のスキーマ確認:** `profiles`テーブルの現状確認
    - ✅ `profiles`テーブル存在確認済み
    - ✅ `bots`テーブル存在確認済み（`points`カラム付き）
    - ❌ `points_history`, `plans`, `point_purchases`テーブル未作成
-   [x] **⚠️ 手動作業完了:** SupabaseのSQL Editorで`database-setup.sql`を実行済み
-   [ ] **ポイント履歴テーブル作成:** `points_history`テーブル
    ```sql
    CREATE TABLE points_history (
      id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
      user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
      points INTEGER NOT NULL,
      transaction_type VARCHAR(20) NOT NULL, -- 'earned', 'spent', 'purchased', 'manual_grant'
      description TEXT,
      reference_id UUID, -- 関連するトランザクションID（購入、チャット等）
      created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
    );
    ```
-   [ ] **プランテーブル作成:** `plans`テーブル（将来の課金プラン用）
    ```sql
    CREATE TABLE plans (
      id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
      name VARCHAR(100) NOT NULL,
      description TEXT,
      price INTEGER NOT NULL, -- 円単位
      points INTEGER NOT NULL, -- 付与ポイント数
      is_active BOOLEAN DEFAULT true,
      created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
    );
    ```
-   [ ] **購入履歴テーブル作成:** `point_purchases`テーブル
    ```sql
    CREATE TABLE point_purchases (
      id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
      user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
      plan_id UUID REFERENCES plans(id),
      amount INTEGER NOT NULL, -- 支払い金額
      points INTEGER NOT NULL, -- 付与されたポイント
      status VARCHAR(20) DEFAULT 'pending', -- 'pending', 'completed', 'failed', 'refunded'
      stripe_payment_intent_id VARCHAR(255), -- Stripe決済ID
      created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      completed_at TIMESTAMP WITH TIME ZONE
    );
    ```

### 2. 認証とプロフィール連携
-   [ ] **プロフィールテーブル更新:** `profiles`テーブルに`current_points`列追加
-   [ ] **トリガー設定:** `auth.users`登録時の`profiles`自動作成トリガー
-   [ ] **RLS設定:** `profiles`, `points_history`, `point_purchases`テーブルのポリシー設定

### 3. API エンドポイント作成

#### プロフィール管理API
-   [ ] **GET `/api/account/profile`:** プロフィール情報取得
-   [ ] **PUT `/api/account/profile`:** プロフィール情報更新
-   [ ] **POST `/api/account/avatar`:** アバター画像アップロード

#### ポイント管理API
-   [ ] **GET `/api/account/points`:** 現在のポイント残高取得
-   [ ] **GET `/api/account/points/history`:** ポイント履歴取得
-   [ ] **POST `/api/account/points/spend`:** ポイント消費処理

#### 決済・購入API
-   [ ] **GET `/api/account/plans`:** 購入可能プラン一覧取得
-   [ ] **POST `/api/account/purchase/create-intent`:** Stripe決済開始
-   [ ] **POST `/api/account/purchase/confirm`:** 決済完了・ポイント付与

#### 管理者用API
-   [ ] **POST `/api/admin/points/grant`:** 手動ポイント付与
-   [ ] **GET `/api/admin/users`:** ユーザー一覧取得
-   [ ] **GET `/api/admin/transactions`:** 全取引履歴取得

### 4. セキュリティ・認証
-   [ ] **管理者権限チェック:** `profiles.role`で管理者判定
-   [ ] **API認証:** 全エンドポイントでセッション確認
-   [ ] **入力値検証:** 各APIでバリデーション実装

### 5. 初期データ・設定
-   [ ] **サンプルプラン作成:** 基本的なポイント購入プラン
-   [ ] **環境変数設定:** Stripe関連の設定
-   [ ] **管理者アカウント設定:** 初期管理者の作成

### 6. フロントエンド連携
-   [ ] **マイページ更新:** `/account/mypage`のダミーデータをAPI連携に変更
-   [ ] **ポイント表示:** ヘッダー等でポイント残高表示
-   [ ] **購入画面作成:** ポイント購入用UI

## 🚀 作業開始順序
1. データベーススキーマ確認・構築
2. 基本API（プロフィール・ポイント）作成
3. 決済連携実装
4. 管理者機能実装
5. フロントエンド連携
