# お気に入り機能実装計画書

## 📋 プロジェクト概要
Chat Depaアプリケーションにお気に入りボット機能を追加し、ユーザーが頻繁に使用するボットを簡単にアクセスできるようにする。

## 🎯 実装目標
- ユーザーがボットをお気に入りに登録/解除できる
- お気に入りボットを一覧表示できる
- お気に入りボットを優先的に表示する
- お気に入り状態をリアルタイムで同期する

---

## 📊 実装フェーズ

### Phase 1: データベース設計・セットアップ
- [ ] **1.1 Supabaseテーブル設計**
  - [ ] `user_favorites`テーブル作成
  - [ ] カラム設計: `id`, `user_id`, `bot_id`, `created_at`
  - [ ] 外部キー制約設定
  - [ ] RLS（Row Level Security）設定

- [ ] **1.2 データベースマイグレーション**
  - [ ] SQLスクリプト作成
  - [ ] 本番環境でのマイグレーション実行
  - [ ] テストデータ投入

- [ ] **1.3 Supabase設定確認**
  - [ ] 環境変数確認（`NEXT_PUBLIC_SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`）
  - [ ] RLSポリシー設定
  - [ ] インデックス最適化

### Phase 2: バックエンドAPI実装
- [ ] **2.1 お気に入り管理API**
  - [ ] `POST /api/favorites/add` - お気に入り追加
  - [ ] `DELETE /api/favorites/remove` - お気に入り削除
  - [ ] `GET /api/favorites/list` - お気に入り一覧取得
  - [ ] `GET /api/favorites/check/:botId` - お気に入り状態確認

- [ ] **2.2 認証・認可処理**
  - [ ] ユーザー認証チェック
  - [ ] 権限検証
  - [ ] エラーハンドリング

- [ ] **2.3 データ検証**
  - [ ] 入力値バリデーション
  - [ ] 重複チェック
  - [ ] 存在チェック

### Phase 3: フロントエンドUI実装
- [ ] **3.1 お気に入りボタンコンポーネント**
  - [ ] `FavoriteButton.tsx`作成
  - [ ] ハートアイコン（空/塗りつぶし）
  - [ ] ホバーエフェクト
  - [ ] アニメーション効果

- [ ] **3.2 ボットカード統合**
  - [ ] `BotCard.tsx`にお気に入りボタン追加
  - [ ] お気に入り状態表示
  - [ ] クリックイベント処理

- [ ] **3.3 お気に入り一覧ページ**
  - [ ] `/favorites`ページ作成
  - [ ] お気に入りボット一覧表示
  - [ ] お気に入り解除機能
  - [ ] 空状態表示

### Phase 4: 状態管理・データ同期
- [ ] **4.1 グローバル状態管理**
  - [ ] `useFavorites`カスタムフック作成
  - [ ] お気に入り状態のキャッシュ
  - [ ] リアルタイム同期

- [ ] **4.2 データフェッチング**
  - [ ] SWR/React Query設定
  - [ ] オプティミスティック更新
  - [ ] エラー処理

- [ ] **4.3 パフォーマンス最適化**
  - [ ] メモ化
  - [ ] 遅延読み込み
  - [ ] キャッシュ戦略

### Phase 5: UI/UX改善
- [ ] **5.1 お気に入りセクション追加**
  - [ ] トップページにお気に入りセクション追加
  - [ ] お気に入りボット優先表示
  - [ ] セクションタイトル・デザイン

- [ ] **5.2 ナビゲーション統合**
  - [ ] ヘッダーにお気に入りリンク追加
  - [ ] お気に入り数表示
  - [ ] アクティブ状態表示

- [ ] **5.3 レスポンシブ対応**
  - [ ] モバイル対応
  - [ ] タブレット対応
  - [ ] デスクトップ対応

### Phase 6: テスト・デバッグ
- [ ] **6.1 単体テスト**
  - [ ] API エンドポイントテスト
  - [ ] コンポーネントテスト
  - [ ] カスタムフックテスト

- [ ] **6.2 統合テスト**
  - [ ] お気に入り追加/削除フロー
  - [ ] 認証フロー
  - [ ] エラーケース

- [ ] **6.3 E2Eテスト**
  - [ ] Playwrightテスト作成
  - [ ] ユーザーシナリオテスト
  - [ ] パフォーマンステスト

### Phase 7: デプロイ・本番対応
- [ ] **7.1 本番環境準備**
  - [ ] Vercel環境変数設定
  - [ ] Supabase本番環境確認
  - [ ] ドメイン設定

- [ ] **7.2 デプロイ実行**
  - [ ] ステージング環境デプロイ
  - [ ] 本番環境デプロイ
  - [ ] 動作確認

- [ ] **7.3 監視・ログ**
  - [ ] エラーログ設定
  - [ ] パフォーマンス監視
  - [ ] ユーザー行動分析

---

## 🗄️ Supabase設定詳細

### 1. テーブル設計
```sql
-- user_favoritesテーブル
CREATE TABLE user_favorites (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  bot_id UUID REFERENCES bots(id) ON DELETE CASCADE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(user_id, bot_id)
);

-- インデックス作成
CREATE INDEX idx_user_favorites_user_id ON user_favorites(user_id);
CREATE INDEX idx_user_favorites_bot_id ON user_favorites(bot_id);
CREATE INDEX idx_user_favorites_created_at ON user_favorites(created_at);
```

### 2. RLSポリシー設定
```sql
-- RLS有効化
ALTER TABLE user_favorites ENABLE ROW LEVEL SECURITY;

-- ユーザーは自分のお気に入りのみアクセス可能
CREATE POLICY "Users can view their own favorites" ON user_favorites
  FOR SELECT USING (auth.uid() = user_id);

-- ユーザーは自分のお気に入りのみ追加可能
CREATE POLICY "Users can insert their own favorites" ON user_favorites
  FOR INSERT WITH CHECK (auth.uid() = user_id);

-- ユーザーは自分のお気に入りのみ削除可能
CREATE POLICY "Users can delete their own favorites" ON user_favorites
  FOR DELETE USING (auth.uid() = user_id);
```

### 3. 環境変数設定
```env
# Vercel環境変数
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key
```

---

## 📁 ファイル構成

```
src/
├── app/
│   ├── api/
│   │   └── favorites/
│   │       ├── add/
│   │       │   └── route.ts
│   │       ├── remove/
│   │       │   └── route.ts
│   │       ├── list/
│   │       │   └── route.ts
│   │       └── check/
│   │           └── [botId]/
│   │               └── route.ts
│   └── favorites/
│       └── page.tsx
├── components/
│   ├── ui/
│   │   └── FavoriteButton.tsx
│   └── favorites/
│       ├── FavoriteList.tsx
│       └── FavoriteSection.tsx
├── hooks/
│   └── useFavorites.ts
├── lib/
│   └── favorites.ts
└── types/
    └── favorites.ts
```

---

## ⏱️ 実装スケジュール

| フェーズ | 期間 | 担当 | 完了予定 |
|---------|------|------|----------|
| Phase 1 | 1日 | 全員 | Day 1 |
| Phase 2 | 2日 | バックエンド | Day 2-3 |
| Phase 3 | 2日 | フロントエンド | Day 4-5 |
| Phase 4 | 1日 | フロントエンド | Day 6 |
| Phase 5 | 1日 | フロントエンド | Day 7 |
| Phase 6 | 1日 | 全員 | Day 8 |
| Phase 7 | 1日 | 全員 | Day 9 |

**総実装期間: 9日間**

---

## 🚀 デプロイ手順

### 1. 本番環境準備
```bash
# 1. Supabase本番環境でマイグレーション実行
psql -h your-supabase-host -U postgres -d postgres -f migrations/create_favorites_table.sql

# 2. Vercel環境変数設定
vercel env add NEXT_PUBLIC_SUPABASE_URL
vercel env add NEXT_PUBLIC_SUPABASE_ANON_KEY
vercel env add SUPABASE_SERVICE_ROLE_KEY
```

### 2. デプロイ実行
```bash
# 1. コードコミット
git add .
git commit -m "Add favorites functionality"
git push origin main

# 2. Vercel自動デプロイ確認
# 3. 本番環境動作確認
```

### 3. 動作確認チェックリスト
- [ ] お気に入り追加/削除が正常に動作する
- [ ] お気に入り一覧が正しく表示される
- [ ] 認証ユーザーのみアクセス可能
- [ ] エラーハンドリングが適切に動作する
- [ ] パフォーマンスが良好である

---

## 📝 注意事項

1. **セキュリティ**: RLSポリシーを必ず設定し、ユーザーは自分のデータのみアクセス可能にする
2. **パフォーマンス**: インデックスを適切に設定し、クエリパフォーマンスを最適化する
3. **UX**: お気に入り操作は即座に反映され、ユーザーに分かりやすいフィードバックを提供する
4. **エラーハンドリング**: ネットワークエラーやサーバーエラーを適切に処理する
5. **アクセシビリティ**: スクリーンリーダー対応やキーボードナビゲーションを考慮する

---

## 🎉 完了条件

- [ ] ユーザーがボットをお気に入りに登録/解除できる
- [ ] お気に入りボットが一覧表示される
- [ ] お気に入りボットが優先的に表示される
- [ ] 認証・認可が適切に動作する
- [ ] エラーハンドリングが実装されている
- [ ] レスポンシブデザインが対応されている
- [ ] 本番環境で正常に動作する
- [ ] テストが通過している
