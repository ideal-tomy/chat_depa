# ãƒœãƒƒãƒˆè¡¨ç¤ºé †åºæœ€é©åŒ–ãƒ—ãƒ©ãƒ³

## æ¦‚è¦

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆ©ç”¨é »åº¦ã‚’æœ€å¤§åŒ–ã—ã€ã‚µã‚¤ãƒˆã®ä½¿ã„ã‚„ã™ã•ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã€ãƒœãƒƒãƒˆã®è¡¨ç¤ºé †åºã‚’å‹•çš„ã«æœ€é©åŒ–ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚åˆ©ç”¨çµ±è¨ˆã€ç®¡ç†è€…è¨­å®šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•åˆ†æã‚’çµ„ã¿åˆã‚ã›ãŸå¤šå±¤çš„ãªè¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

## 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 1.1 æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ 

#### `bot_usage_stats` ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE bot_usage_stats (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  bot_id UUID REFERENCES bots(id) ON DELETE CASCADE,
  total_uses INTEGER DEFAULT 0,
  unique_users INTEGER DEFAULT 0,
  avg_session_duration INTEGER DEFAULT 0, -- ç§’å˜ä½
  completion_rate DECIMAL(5,2) DEFAULT 0.0, -- ä¼šè©±å®Œäº†ç‡
  user_rating DECIMAL(3,2) DEFAULT 0.0, -- å¹³å‡è©•ä¾¡
  last_used_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### `bot_featured_settings` ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE bot_featured_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  bot_id UUID REFERENCES bots(id) ON DELETE CASCADE,
  display_type VARCHAR(50) NOT NULL, -- 'pickup', 'new', 'trending', 'category_featured'
  category_id VARCHAR(100), -- ã‚«ãƒ†ã‚´ãƒªåˆ¥è¨­å®šç”¨
  priority INTEGER DEFAULT 0, -- è¡¨ç¤ºå„ªå…ˆåº¦ï¼ˆé«˜ã„ã»ã©ä¸Šä½ï¼‰
  start_date DATE,
  end_date DATE,
  is_active BOOLEAN DEFAULT true,
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### `bot_user_interactions` ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE bot_user_interactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  bot_id UUID REFERENCES bots(id) ON DELETE CASCADE,
  interaction_type VARCHAR(50) NOT NULL, -- 'view', 'start_chat', 'complete_chat', 'rate', 'favorite'
  session_duration INTEGER, -- ç§’å˜ä½
  rating INTEGER, -- 1-5ã®è©•ä¾¡
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 1.2 æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µ

#### `bots` ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ 
```sql
ALTER TABLE bots ADD COLUMN IF NOT EXISTS featured_priority INTEGER DEFAULT 0;
ALTER TABLE bots ADD COLUMN IF NOT EXISTS is_pickup BOOLEAN DEFAULT false;
ALTER TABLE bots ADD COLUMN IF NOT EXISTS is_new BOOLEAN DEFAULT false;
ALTER TABLE bots ADD COLUMN IF NOT EXISTS is_trending BOOLEAN DEFAULT false;
ALTER TABLE bots ADD COLUMN IF NOT EXISTS manual_sort_order INTEGER DEFAULT 0;
```

## 2. è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯è¨­è¨ˆ

### 2.1 å¤šå±¤è¡¨ç¤ºã‚·ã‚¹ãƒ†ãƒ 

#### ãƒ¬ã‚¤ãƒ¤ãƒ¼1: ç®¡ç†è€…æŒ‡å®šï¼ˆæœ€å„ªå…ˆï¼‰
- ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒœãƒƒãƒˆ
- æ–°ç€ãƒœãƒƒãƒˆ
- æ³¨ç›®ãƒœãƒƒãƒˆ
- ã‚«ãƒ†ã‚´ãƒªåˆ¥ç‰¹é›†ãƒœãƒƒãƒˆ

#### ãƒ¬ã‚¤ãƒ¤ãƒ¼2: å‹•çš„ãƒ©ãƒ³ã‚­ãƒ³ã‚°
- åˆ©ç”¨é »åº¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°
- ãƒ¦ãƒ¼ã‚¶ãƒ¼è©•ä¾¡ãƒ©ãƒ³ã‚­ãƒ³ã‚°
- å®Œäº†ç‡ãƒ©ãƒ³ã‚­ãƒ³ã‚°
- æ–°ç€åº¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°

#### ãƒ¬ã‚¤ãƒ¤ãƒ¼3: ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éå»åˆ©ç”¨å±¥æ­´
- é¡ä¼¼ãƒœãƒƒãƒˆæ¨è–¦
- ã‚«ãƒ†ã‚´ãƒªåˆ¥å¥½ã¿åˆ†æ

### 2.2 è¡¨ç¤ºé †åºè¨ˆç®—ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

```typescript
interface BotDisplayScore {
  botId: string;
  score: number;
  factors: {
    manualPriority: number;    // ç®¡ç†è€…è¨­å®šå„ªå…ˆåº¦
    usageScore: number;        // åˆ©ç”¨é »åº¦ã‚¹ã‚³ã‚¢
    ratingScore: number;       // è©•ä¾¡ã‚¹ã‚³ã‚¢
    recencyScore: number;      // æ–°ç€åº¦ã‚¹ã‚³ã‚¢
    personalizationScore: number; // ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚³ã‚¢
  };
}

function calculateDisplayScore(bot: Bot, userContext?: UserContext): BotDisplayScore {
  const score = {
    manualPriority: bot.featured_priority * 1000,
    usageScore: calculateUsageScore(bot.usage_stats),
    ratingScore: calculateRatingScore(bot.usage_stats),
    recencyScore: calculateRecencyScore(bot.created_at),
    personalizationScore: calculatePersonalizationScore(bot, userContext)
  };

  return {
    botId: bot.id,
    score: Object.values(score).reduce((sum, val) => sum + val, 0),
    factors: score
  };
}
```

## 3. å®Ÿè£…è¨ˆç”»

### 3.1 Phase 1: åŸºæœ¬çµ±è¨ˆã‚·ã‚¹ãƒ†ãƒ ï¼ˆ1-2é€±é–“ï¼‰

#### 3.1.1 åˆ©ç”¨çµ±è¨ˆåé›†API
```typescript
// src/app/api/bot/stats/update/route.ts
export async function POST(req: NextRequest) {
  const { botId, userId, interactionType, sessionData } = await req.json();
  
  // åˆ©ç”¨çµ±è¨ˆã‚’æ›´æ–°
  await updateBotUsageStats(botId, userId, interactionType, sessionData);
  
  // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ›´æ–°
  await updateBotRankings();
}
```

#### 3.1.2 çµ±è¨ˆè¨ˆç®—ãƒãƒƒãƒå‡¦ç†
```typescript
// src/lib/bot-stats/calculate-rankings.ts
export async function calculateBotRankings() {
  // æ—¥æ¬¡ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—
  // é€±æ¬¡ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—
  // æœˆæ¬¡ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—
}
```

### 3.2 Phase 2: ç®¡ç†è€…è¨­å®šã‚·ã‚¹ãƒ†ãƒ ï¼ˆ1é€±é–“ï¼‰

#### 3.2.1 ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ‹¡å¼µ
- ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒœãƒƒãƒˆè¨­å®š
- æ–°ç€ãƒœãƒƒãƒˆè¨­å®š
- ã‚«ãƒ†ã‚´ãƒªåˆ¥ç‰¹é›†è¨­å®š
- æ‰‹å‹•å„ªå…ˆåº¦è¨­å®š

#### 3.2.2 è¨­å®šAPI
```typescript
// src/app/api/admin/bot-featured/route.ts
export async function POST(req: NextRequest) {
  const { botId, displayType, priority, categoryId, startDate, endDate } = await req.json();
  
  await setBotFeatured(botId, {
    displayType,
    priority,
    categoryId,
    startDate,
    endDate
  });
}
```

### 3.3 Phase 3: ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ2é€±é–“ï¼‰

#### 3.3.1 ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•åˆ†æ
```typescript
// src/lib/user-analytics/analyze-preferences.ts
export async function analyzeUserPreferences(userId: string) {
  // åˆ©ç”¨å±¥æ­´åˆ†æ
  // ã‚«ãƒ†ã‚´ãƒªåˆ¥å¥½ã¿åˆ†æ
  // é¡ä¼¼ãƒœãƒƒãƒˆæ¨è–¦
}
```

#### 3.3.2 æ¨è–¦ã‚·ã‚¹ãƒ†ãƒ 
```typescript
// src/lib/recommendation/engine.ts
export async function getPersonalizedRecommendations(userId: string) {
  const userPreferences = await analyzeUserPreferences(userId);
  const recommendations = await generateRecommendations(userPreferences);
  return recommendations;
}
```

## 4. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

### 4.1 è¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ‹¡å¼µ

#### 4.1.1 å‹•çš„ã‚«ãƒ«ãƒ¼ã‚»ãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
```typescript
// src/components/ui/DynamicCarousel.tsx
interface DynamicCarouselProps {
  displayType: 'pickup' | 'new' | 'trending' | 'category_featured';
  categoryId?: string;
  maxItems?: number;
  showRanking?: boolean;
}

export default function DynamicCarousel({ 
  displayType, 
  categoryId, 
  maxItems = 10,
  showRanking = false 
}: DynamicCarouselProps) {
  const [bots, setBots] = useState<Bot[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchDynamicBots(displayType, categoryId, maxItems);
  }, [displayType, categoryId, maxItems]);

  return (
    <div className="dynamic-carousel">
      {showRanking && (
        <div className="ranking-badges">
          {bots.map((bot, index) => (
            <RankingBadge key={bot.id} rank={index + 1} />
          ))}
        </div>
      )}
      <Carousel items={bots} />
    </div>
  );
}
```

#### 4.1.2 ç®¡ç†è€…è¨­å®šUI
```typescript
// src/components/admin/BotFeaturedSettings.tsx
export default function BotFeaturedSettings() {
  return (
    <div className="bot-featured-settings">
      <Tabs>
        <Tab label="ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®š">
          <PickupBotSelector />
        </Tab>
        <Tab label="æ–°ç€è¨­å®š">
          <NewBotSelector />
        </Tab>
        <Tab label="ã‚«ãƒ†ã‚´ãƒªç‰¹é›†">
          <CategoryFeaturedSelector />
        </Tab>
        <Tab label="æ‰‹å‹•å„ªå…ˆåº¦">
          <ManualPrioritySetter />
        </Tab>
      </Tabs>
    </div>
  );
}
```

### 4.2 ãƒšãƒ¼ã‚¸åˆ¥è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯

#### 4.2.1 ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸
```typescript
// src/app/page.tsx
export default function HomePage() {
  return (
    <main>
      {/* ç®¡ç†è€…æŒ‡å®šãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ— */}
      <DynamicCarousel displayType="pickup" maxItems={6} showRanking={true} />
      
      {/* æ–°ç€ãƒœãƒƒãƒˆ */}
      <DynamicCarousel displayType="new" maxItems={8} />
      
      {/* ã‚«ãƒ†ã‚´ãƒªåˆ¥ç‰¹é›† */}
      {categories.map(category => (
        <DynamicCarousel 
          key={category.id}
          displayType="category_featured" 
          categoryId={category.id}
          maxItems={6}
        />
      ))}
      
      {/* ãƒˆãƒ¬ãƒ³ãƒ‰ãƒœãƒƒãƒˆ */}
      <DynamicCarousel displayType="trending" maxItems={10} showRanking={true} />
    </main>
  );
}
```

#### 4.2.2 ãƒœãƒƒãƒˆä¸€è¦§ãƒšãƒ¼ã‚¸
```typescript
// src/components/bots/BotPageClient.tsx
export default function BotPageClient() {
  const [sortMethod, setSortMethod] = useState<'popular' | 'newest' | 'rating' | 'trending'>('popular');
  
  const fetchBots = useCallback(async (filters: FilterState, isLoadMore = false) => {
    const response = await fetch(`/api/bots?sort=${sortMethod}&category=${filters.category}&page=${page}`);
    // å‹•çš„ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«åŸºã¥ããƒœãƒƒãƒˆå–å¾—
  }, [sortMethod, filters, page]);
}
```

## 5. APIè¨­è¨ˆ

### 5.1 å‹•çš„ãƒœãƒƒãƒˆå–å¾—API
```typescript
// src/app/api/bots/dynamic/route.ts
export async function GET(req: NextRequest) {
  const { searchParams } = new URL(req.url);
  const displayType = searchParams.get('type');
  const categoryId = searchParams.get('category');
  const maxItems = parseInt(searchParams.get('limit') || '10');
  const userId = await getCurrentUserId();

  const bots = await getDynamicBots({
    displayType,
    categoryId,
    maxItems,
    userId
  });

  return NextResponse.json({ bots });
}
```

### 5.2 çµ±è¨ˆæ›´æ–°API
```typescript
// src/app/api/bot/interaction/route.ts
export async function POST(req: NextRequest) {
  const { botId, interactionType, sessionData } = await req.json();
  const userId = await getCurrentUserId();

  await recordBotInteraction({
    botId,
    userId,
    interactionType,
    sessionData
  });

  return NextResponse.json({ success: true });
}
```

## 6. é‹ç”¨ãƒ»ç›£è¦–

### 6.1 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
- ãƒœãƒƒãƒˆè¡¨ç¤ºé †åºã®åŠ¹æœæ¸¬å®š
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆåˆ†æ
- ã‚¯ãƒªãƒƒã‚¯ç‡ãƒ»åˆ©ç”¨ç‡ã®è¿½è·¡

### 6.2 A/Bãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
```typescript
// src/lib/ab-testing/display-variants.ts
export const DISPLAY_VARIANTS = {
  CONTROL: 'manual_only',
  VARIANT_A: 'dynamic_ranking',
  VARIANT_B: 'personalized',
  VARIANT_C: 'hybrid'
};
```

### 6.3 è‡ªå‹•æœ€é©åŒ–
- åˆ©ç”¨çµ±è¨ˆã«åŸºã¥ãè‡ªå‹•ãƒ©ãƒ³ã‚­ãƒ³ã‚°èª¿æ•´
- å­£ç¯€æ€§ãƒ»ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’è€ƒæ…®ã—ãŸè¡¨ç¤ºèª¿æ•´
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã«ã‚ˆã‚‹ç¶™ç¶šæ”¹å–„

## 7. å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

### Week 1-2: åŸºç›¤æ§‹ç¯‰
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- åŸºæœ¬çµ±è¨ˆåé›†ã‚·ã‚¹ãƒ†ãƒ 
- åˆ©ç”¨çµ±è¨ˆAPIå®Ÿè£…

### Week 3: ç®¡ç†è€…æ©Ÿèƒ½
- ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ‹¡å¼µ
- ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»æ–°ç€è¨­å®šæ©Ÿèƒ½
- æ‰‹å‹•å„ªå…ˆåº¦è¨­å®š

### Week 4-5: å‹•çš„ãƒ©ãƒ³ã‚­ãƒ³ã‚°
- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµ±è¨ˆæ›´æ–°
- è¡¨ç¤ºé †åºæœ€é©åŒ–

### Week 6-7: ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
- ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•åˆ†æ
- æ¨è–¦ã‚·ã‚¹ãƒ†ãƒ 
- å€‹äººåŒ–è¡¨ç¤º

### Week 8: ãƒ†ã‚¹ãƒˆãƒ»æœ€é©åŒ–
- A/Bãƒ†ã‚¹ãƒˆå®Ÿè£…
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
- ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ

## 8. æœŸå¾…åŠ¹æœ

### 8.1 ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“å‘ä¸Š
- é–¢é€£æ€§ã®é«˜ã„ãƒœãƒƒãƒˆãŒä¸Šä½è¡¨ç¤º
- æ–°ç€ãƒ»æ³¨ç›®ãƒœãƒƒãƒˆã®ç™ºè¦‹ä¿ƒé€²
- ã‚«ãƒ†ã‚´ãƒªåˆ¥æœ€é©åŒ–

### 8.2 ãƒ“ã‚¸ãƒã‚¹åŠ¹æœ
- ãƒœãƒƒãƒˆåˆ©ç”¨ç‡å‘ä¸Š
- ãƒ¦ãƒ¼ã‚¶ãƒ¼æ»åœ¨æ™‚é–“å»¶é•·
- ãƒªãƒ”ãƒ¼ãƒˆç‡å‘ä¸Š

### 8.3 é‹ç”¨åŠ¹ç‡åŒ–
- ãƒ‡ãƒ¼ã‚¿é§†å‹•ã®è¡¨ç¤ºæœ€é©åŒ–
- ç®¡ç†è€…ã®æ‰‹å‹•èª¿æ•´è² è·è»½æ¸›
- ç¶™ç¶šçš„ãªæ”¹å–„ã‚µã‚¤ã‚¯ãƒ«

## 9. æŠ€è¡“çš„è€ƒæ…®äº‹é …

### 9.1 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã®æœ€é©åŒ–
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã®åŠ¹ç‡åŒ–

### 9.2 ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£
- çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®å®šæœŸçš„ãªé›†ç´„
- å¤ã„ãƒ‡ãƒ¼ã‚¿ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
- è² è·åˆ†æ•£ã®å®Ÿè£…

### 9.3 ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®åŒ¿ååŒ–
- å€‹äººæƒ…å ±ã®é©åˆ‡ãªç®¡ç†
- GDPRæº–æ‹ ã®å®Ÿè£…

## 10. é–¢é€£ãƒœãƒƒãƒˆæ¨è–¦ã‚·ã‚¹ãƒ†ãƒ 

### 10.1 æ¨è–¦ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ è¨­è¨ˆ

#### 10.1.1 å”èª¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆCollaborative Filteringï¼‰
```typescript
interface UserBotInteraction {
  userId: string;
  botId: string;
  interactionStrength: number; // åˆ©ç”¨é »åº¦ã€è©•ä¾¡ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ã‹ã‚‰è¨ˆç®—
  timestamp: Date;
}

interface BotSimilarity {
  botId1: string;
  botId2: string;
  similarityScore: number; // 0-1ã®é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢
  commonUsers: number; // å…±é€šåˆ©ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼é–“ã®é¡ä¼¼åº¦è¨ˆç®—
function calculateUserSimilarity(user1: string, user2: string): number {
  const user1Bots = getUserBotInteractions(user1);
  const user2Bots = getUserBotInteractions(user2);
  
  const intersection = user1Bots.filter(bot => 
    user2Bots.some(u2Bot => u2Bot.botId === bot.botId)
  );
  
  const union = [...user1Bots, ...user2Bots];
  return intersection.length / union.length; // Jaccardé¡ä¼¼åº¦
}

// ãƒœãƒƒãƒˆé–“ã®é¡ä¼¼åº¦è¨ˆç®—
function calculateBotSimilarity(bot1: string, bot2: string): number {
  const bot1Users = getBotUsers(bot1);
  const bot2Users = getBotUsers(bot2);
  
  const commonUsers = bot1Users.filter(user => 
    bot2Users.includes(user)
  );
  
  return commonUsers.length / Math.sqrt(bot1Users.length * bot2Users.length);
}
```

#### 10.1.2 ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ™ãƒ¼ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
```typescript
interface BotFeatures {
  botId: string;
  category: string;
  tags: string[];
  complexity: 'simple' | 'medium' | 'advanced';
  useCases: string[];
  targetAudience: string[];
  features: string[]; // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡ãªã©
}

function calculateContentSimilarity(bot1: BotFeatures, bot2: BotFeatures): number {
  const categoryMatch = bot1.category === bot2.category ? 0.3 : 0;
  const tagOverlap = calculateTagOverlap(bot1.tags, bot2.tags) * 0.2;
  const complexityMatch = bot1.complexity === bot2.complexity ? 0.1 : 0;
  const useCaseOverlap = calculateUseCaseOverlap(bot1.useCases, bot2.useCases) * 0.2;
  const audienceMatch = calculateAudienceOverlap(bot1.targetAudience, bot2.targetAudience) * 0.1;
  const featureMatch = calculateFeatureOverlap(bot1.features, bot2.features) * 0.1;
  
  return categoryMatch + tagOverlap + complexityMatch + useCaseOverlap + audienceMatch + featureMatch;
}
```

### 10.2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆï¼ˆè¿½åŠ ï¼‰

#### `bot_recommendations` ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE bot_recommendations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  source_bot_id UUID REFERENCES bots(id) ON DELETE CASCADE,
  recommended_bot_id UUID REFERENCES bots(id) ON DELETE CASCADE,
  recommendation_type VARCHAR(50) NOT NULL, -- 'collaborative', 'content_based', 'hybrid'
  similarity_score DECIMAL(5,4) NOT NULL,
  confidence_score DECIMAL(5,4) NOT NULL,
  click_through_rate DECIMAL(5,4) DEFAULT 0.0,
  conversion_rate DECIMAL(5,4) DEFAULT 0.0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(source_bot_id, recommended_bot_id)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_bot_recommendations_source ON bot_recommendations(source_bot_id);
CREATE INDEX idx_bot_recommendations_score ON bot_recommendations(similarity_score DESC);
```

#### `user_recommendation_feedback` ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE user_recommendation_feedback (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  source_bot_id UUID REFERENCES bots(id) ON DELETE CASCADE,
  recommended_bot_id UUID REFERENCES bots(id) ON DELETE CASCADE,
  action_type VARCHAR(50) NOT NULL, -- 'view', 'click', 'use', 'dismiss'
  session_id UUID,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 10.3 æ¨è–¦ã‚·ã‚¹ãƒ†ãƒ API

#### 10.3.1 é–¢é€£ãƒœãƒƒãƒˆå–å¾—API
```typescript
// src/app/api/bot/recommendations/route.ts
export async function GET(req: NextRequest) {
  const { searchParams } = new URL(req.url);
  const botId = searchParams.get('botId');
  const userId = searchParams.get('userId');
  const limit = parseInt(searchParams.get('limit') || '6');
  const type = searchParams.get('type') || 'hybrid'; // 'collaborative', 'content_based', 'hybrid'

  if (!botId) {
    return NextResponse.json({ error: 'botId is required' }, { status: 400 });
  }

  const recommendations = await getBotRecommendations({
    botId,
    userId,
    limit,
    type
  });

  return NextResponse.json({ recommendations });
}

async function getBotRecommendations({
  botId,
  userId,
  limit,
  type
}: {
  botId: string;
  userId?: string;
  limit: number;
  type: string;
}) {
  let recommendations = [];

  if (type === 'collaborative' || type === 'hybrid') {
    const collaborativeRecs = await getCollaborativeRecommendations(botId, limit);
    recommendations.push(...collaborativeRecs);
  }

  if (type === 'content_based' || type === 'hybrid') {
    const contentRecs = await getContentBasedRecommendations(botId, limit);
    recommendations.push(...contentRecs);
  }

  // é‡è¤‡é™¤å»ã¨ã‚¹ã‚³ã‚¢çµ±åˆ
  recommendations = mergeAndDeduplicateRecommendations(recommendations);
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰ã®èª¿æ•´
  if (userId) {
    recommendations = await personalizeRecommendations(recommendations, userId);
  }

  return recommendations.slice(0, limit);
}
```

#### 10.3.2 æ¨è–¦ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯API
```typescript
// src/app/api/bot/recommendation-feedback/route.ts
export async function POST(req: NextRequest) {
  const { sourceBotId, recommendedBotId, actionType, sessionId } = await req.json();
  const userId = await getCurrentUserId();

  await recordRecommendationFeedback({
    userId,
    sourceBotId,
    recommendedBotId,
    actionType,
    sessionId
  });

  // æ¨è–¦ã‚¹ã‚³ã‚¢ã®æ›´æ–°
  await updateRecommendationScores(sourceBotId, recommendedBotId, actionType);

  return NextResponse.json({ success: true });
}
```

### 10.4 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

#### 10.4.1 é–¢é€£ãƒœãƒƒãƒˆè¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
```typescript
// src/components/bots/RelatedBotsRecommendation.tsx
interface RelatedBotsRecommendationProps {
  currentBotId: string;
  maxItems?: number;
  displayType?: 'sidebar' | 'carousel' | 'grid';
  showReason?: boolean;
}

export default function RelatedBotsRecommendation({
  currentBotId,
  maxItems = 6,
  displayType = 'carousel',
  showReason = true
}: RelatedBotsRecommendationProps) {
  const [recommendations, setRecommendations] = useState<BotRecommendation[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchRecommendations();
  }, [currentBotId]);

  const fetchRecommendations = async () => {
    try {
      const response = await fetch(`/api/bot/recommendations?botId=${currentBotId}&limit=${maxItems}`);
      const data = await response.json();
      setRecommendations(data.recommendations);
    } catch (error) {
      console.error('Failed to fetch recommendations:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleBotClick = async (recommendedBotId: string) => {
    // æ¨è–¦ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¨˜éŒ²
    await fetch('/api/bot/recommendation-feedback', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        sourceBotId: currentBotId,
        recommendedBotId,
        actionType: 'click',
        sessionId: generateSessionId()
      })
    });
  };

  if (loading) {
    return <RelatedBotsSkeleton count={maxItems} />;
  }

  return (
    <div className="related-bots-recommendation">
      <div className="recommendation-header">
        <h3 className="text-lg font-semibold mb-2">
          <span className="text-primary">ğŸ’¡</span> ã“ã®ãƒœãƒƒãƒˆã‚’ä½¿ã£ãŸäººã¯ã€ã“ã‚“ãªãƒœãƒƒãƒˆã‚‚ä½¿ã£ã¦ã„ã¾ã™
        </h3>
        {showReason && (
          <p className="text-sm text-gray-600 mb-4">
            ã‚ãªãŸã®åˆ©ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡Œå‹•ã‹ã‚‰ã€é–¢é€£æ€§ã®é«˜ã„ãƒœãƒƒãƒˆã‚’ãŠã™ã™ã‚ã—ã¦ã„ã¾ã™
          </p>
        )}
      </div>

      {displayType === 'carousel' && (
        <div className="recommendation-carousel">
          <Carousel items={recommendations} onItemClick={handleBotClick} />
        </div>
      )}

      {displayType === 'grid' && (
        <div className="recommendation-grid grid grid-cols-2 md:grid-cols-3 gap-4">
          {recommendations.map((rec) => (
            <BotRecommendationCard
              key={rec.bot.id}
              bot={rec.bot}
              reason={rec.reason}
              similarityScore={rec.similarityScore}
              onClick={() => handleBotClick(rec.bot.id)}
            />
          ))}
        </div>
      )}

      {displayType === 'sidebar' && (
        <div className="recommendation-sidebar space-y-3">
          {recommendations.map((rec) => (
            <BotRecommendationSidebarItem
              key={rec.bot.id}
              bot={rec.bot}
              reason={rec.reason}
              onClick={() => handleBotClick(rec.bot.id)}
            />
          ))}
        </div>
      )}
    </div>
  );
}
```

#### 10.4.2 æ¨è–¦ç†ç”±è¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
```typescript
// src/components/bots/BotRecommendationCard.tsx
interface BotRecommendationCardProps {
  bot: Bot;
  reason: string;
  similarityScore: number;
  onClick: () => void;
}

export default function BotRecommendationCard({
  bot,
  reason,
  similarityScore,
  onClick
}: BotRecommendationCardProps) {
  return (
    <div 
      className="bot-recommendation-card bg-white rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow cursor-pointer"
      onClick={onClick}
    >
      <div className="p-4">
        <div className="flex items-start space-x-3">
          <div className="flex-shrink-0">
            <BotAvatar bot={bot} size="sm" />
          </div>
          <div className="flex-1 min-w-0">
            <h4 className="text-sm font-medium text-gray-900 truncate">
              {bot.name}
            </h4>
            <p className="text-xs text-gray-500 mt-1 line-clamp-2">
              {bot.description}
            </p>
            <div className="flex items-center justify-between mt-2">
              <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                {reason}
              </span>
              <span className="text-xs text-gray-400">
                {Math.round(similarityScore * 100)}% ãƒãƒƒãƒ
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
```

### 10.5 è¡¨ç¤ºå ´æ‰€ã¨å®Ÿè£…æˆ¦ç•¥

#### 10.5.1 ãƒœãƒƒãƒˆè©³ç´°ãƒšãƒ¼ã‚¸
```typescript
// src/app/bots/[id]/page.tsx
export default function BotDetailPage({ params }: { params: { id: string } }) {
  return (
    <div className="bot-detail-page">
      <div className="main-content">
        <BotInfo botId={params.id} />
        <ChatInterface botId={params.id} />
      </div>
      
      <div className="sidebar">
        <RelatedBotsRecommendation
          currentBotId={params.id}
          displayType="sidebar"
          maxItems={4}
          showReason={true}
        />
      </div>
    </div>
  );
}
```

#### 10.5.2 ãƒãƒ£ãƒƒãƒˆå®Œäº†å¾Œã®æ¨è–¦
```typescript
// src/components/bots/ChatCompletionRecommendation.tsx
export default function ChatCompletionRecommendation({ 
  currentBotId, 
  chatHistory 
}: { 
  currentBotId: string; 
  chatHistory: ChatMessage[] 
}) {
  const [showRecommendations, setShowRecommendations] = useState(false);

  useEffect(() => {
    // ãƒãƒ£ãƒƒãƒˆãŒå®Œäº†ã—ãŸã‚‰æ¨è–¦ã‚’è¡¨ç¤º
    if (chatHistory.length > 2) {
      setShowRecommendations(true);
    }
  }, [chatHistory]);

  if (!showRecommendations) return null;

  return (
    <div className="chat-completion-recommendation bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6 mt-6">
      <div className="text-center mb-4">
        <h3 className="text-lg font-semibold text-gray-900">
          ğŸ‰ ãƒãƒ£ãƒƒãƒˆå®Œäº†ï¼
        </h3>
        <p className="text-sm text-gray-600">
          é–¢é€£ã™ã‚‹ãƒœãƒƒãƒˆã‚‚è©¦ã—ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ
        </p>
      </div>
      
      <RelatedBotsRecommendation
        currentBotId={currentBotId}
        displayType="carousel"
        maxItems={3}
        showReason={false}
      />
    </div>
  );
}
```

#### 10.5.3 ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã®ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºæ¨è–¦
```typescript
// src/components/home/PersonalizedRecommendations.tsx
export default function PersonalizedRecommendations() {
  const [userRecommendations, setUserRecommendations] = useState<Bot[]>([]);
  const { user } = useAuth();

  useEffect(() => {
    if (user) {
      fetchUserRecommendations();
    }
  }, [user]);

  const fetchUserRecommendations = async () => {
    const response = await fetch('/api/bot/recommendations/personalized');
    const data = await response.json();
    setUserRecommendations(data.recommendations);
  };

  if (!user || userRecommendations.length === 0) return null;

  return (
    <section className="personalized-recommendations mb-8">
      <div className="section-header">
        <h2 className="text-2xl font-bold mb-2">
          <span className="text-primary">âœ¨</span> ã‚ãªãŸã«ãŠã™ã™ã‚
        </h2>
        <p className="text-gray-600">
          ã‚ãªãŸã®åˆ©ç”¨å±¥æ­´ã‹ã‚‰ã€é–¢é€£æ€§ã®é«˜ã„ãƒœãƒƒãƒˆã‚’ãŠã™ã™ã‚ã—ã¦ã„ã¾ã™
        </p>
      </div>
      
      <div className="recommendations-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {userRecommendations.map((bot) => (
          <BotCard key={bot.id} bot={bot} />
        ))}
      </div>
    </section>
  );
}
```

### 10.6 æ¨è–¦ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®æœ€é©åŒ–

#### 10.6.1 ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¨è–¦ã‚·ã‚¹ãƒ†ãƒ 
```typescript
// src/lib/recommendation/hybrid-engine.ts
export class HybridRecommendationEngine {
  private collaborativeWeight = 0.6;
  private contentWeight = 0.4;

  async getHybridRecommendations(botId: string, userId?: string): Promise<BotRecommendation[]> {
    const [collaborativeRecs, contentRecs] = await Promise.all([
      this.getCollaborativeRecommendations(botId),
      this.getContentBasedRecommendations(botId)
    ]);

    const hybridRecs = this.mergeRecommendations(collaborativeRecs, contentRecs);
    
    if (userId) {
      return this.personalizeRecommendations(hybridRecs, userId);
    }

    return hybridRecs;
  }

  private mergeRecommendations(
    collaborative: BotRecommendation[],
    content: BotRecommendation[]
  ): BotRecommendation[] {
    const merged = new Map<string, BotRecommendation>();

    // å”èª¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°çµæœã‚’è¿½åŠ 
    collaborative.forEach(rec => {
      merged.set(rec.bot.id, {
        ...rec,
        similarityScore: rec.similarityScore * this.collaborativeWeight
      });
    });

    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ™ãƒ¼ã‚¹çµæœã‚’çµ±åˆ
    content.forEach(rec => {
      const existing = merged.get(rec.bot.id);
      if (existing) {
        existing.similarityScore += rec.similarityScore * this.contentWeight;
        existing.reason = `${existing.reason} + ${rec.reason}`;
      } else {
        merged.set(rec.bot.id, {
          ...rec,
          similarityScore: rec.similarityScore * this.contentWeight
        });
      }
    });

    return Array.from(merged.values())
      .sort((a, b) => b.similarityScore - a.similarityScore);
  }
}
```

### 10.7 åŠ¹æœæ¸¬å®šã¨æ”¹å–„

#### 10.7.1 æ¨è–¦åŠ¹æœã®æ¸¬å®š
```typescript
// src/lib/analytics/recommendation-metrics.ts
export async function calculateRecommendationMetrics() {
  const metrics = {
    clickThroughRate: await calculateCTR(),
    conversionRate: await calculateConversionRate(),
    userSatisfaction: await calculateUserSatisfaction(),
    revenueImpact: await calculateRevenueImpact()
  };

  return metrics;
}

async function calculateCTR(): Promise<number> {
  const { data } = await supabase
    .from('user_recommendation_feedback')
    .select('action_type')
    .eq('action_type', 'click');

  const totalImpressions = await getTotalImpressions();
  return data.length / totalImpressions;
}
```

#### 10.7.2 A/Bãƒ†ã‚¹ãƒˆè¨­å®š
```typescript
// src/lib/ab-testing/recommendation-variants.ts
export const RECOMMENDATION_VARIANTS = {
  CONTROL: {
    algorithm: 'collaborative_only',
    displayType: 'sidebar',
    maxItems: 4
  },
  VARIANT_A: {
    algorithm: 'hybrid',
    displayType: 'carousel',
    maxItems: 6
  },
  VARIANT_B: {
    algorithm: 'content_based',
    displayType: 'grid',
    maxItems: 8
  }
};
```

ã“ã®æ¨è–¦ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯é–¢é€£æ€§ã®é«˜ã„ãƒœãƒƒãƒˆã‚’ç™ºè¦‹ã—ã‚„ã™ããªã‚Šã€ã‚µã‚¤ãƒˆã®åˆ©ç”¨é »åº¦ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æº€è¶³åº¦ãŒå¤§å¹…ã«å‘ä¸Šã—ã¾ã™ã€‚ç‰¹ã«ã€Œã“ã®ãƒœãƒƒãƒˆã‚’ä½¿ã£ãŸäººã¯ã€ã“ã‚“ãªãƒœãƒƒãƒˆã‚‚ä½¿ã£ã¦ã„ã¾ã™ã€ã¨ã„ã†è¡¨ç¤ºã«ã‚ˆã‚Šã€ç¤¾ä¼šçš„è¨¼æ˜åŠ¹æœã‚‚æœŸå¾…ã§ãã¾ã™ã€‚
