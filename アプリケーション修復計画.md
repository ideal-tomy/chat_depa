# アプリケーション修復計画書

## 1. 現状の問題点

現在、アプリケーションはローカル環境とデプロイ環境の両方で複数の深刻なエラーを抱えており、正常に動作しない状態にある。

### ローカル環境 (`localhost:3000`)
- **[致命的] クラッシュエラー**: トップページやボット一覧ページで `TypeError: Cannot read properties of undefined` が発生し、ページが正常に表示されない。
- **[レイアウト] カードサイズの不統一**: ボットカードのサイズが、説明文の長さによってバラバラになっている。
- **[機能不全] APIエラー**: 以下の主要機能でサーバーエラーが発生している。
    - マイページ (`/account/mypage`) でのプロファイル情報取得失敗。
    - ヘッダーでのポイント情報取得失敗 (`API request failed`)。
    - ボットとのチャット実行時のエラー (`Bot use error`)。
- **[表示] タイトルの欠落**: ボット一覧ページ (`/bots`) のメインタイトルが表示されていない。
- **[分類] カテゴリ分類の不正確**: 「学習」が「教育・学習系」に、「揶揄・診断系」が「愚痴・共感系」に分類されており、正しい分類に修正が必要。

### デプロイ環境 (`vercel.app`)
- **[致命的] データベース接続エラー**: Supabaseとの接続に失敗しており、ボット情報などを一切取得できていない。
- **[結果] 機能不全**: 上記の結果、「表示するボットがありません」と表示されるなど、サイト全体が機能していない。

## 2. 根本原因

問題の根源は、以下の2点に集約される。

1.  **コンポーネントの堅牢性不足**: `BotCard`コンポーネントが、データベースから予期せぬ形式（`undefined`など）のデータを受け取った際に、エラーを処理できずクラッシュしている。これが、ローカル環境での多くの表示エラーの元凶である。
2.  **環境変数の設定不備**: Vercelのデプロイ環境に、Supabaseデータベースへ接続するための必須情報（`SUPABASE_URL`, `SUPABASE_ANON_KEY`）が設定されていない。これが、デプロイ環境が機能しない全ての原因である。

## 3. 修復タスク一覧（チェックリスト）

以下のフェーズとタスクを順番に実行し、アプリケーションを完全な状態に復旧させる。

### フェーズ1：ローカル環境の安定化（最優先）

- [x] **タスク1-1: `BotCard`コンポーネントの抜本的改修**
    - [x] どんなデータが渡されても絶対にクラッシュしないよう、防御的なコードを追加する。
    - [x] カードの高さを完全に固定し、レイアウトが崩れないようにする。
    - [x] `line-clamp`ユーティリティを使い、説明文の行数を制限する。
- [x] **タスク1-2: ボット一覧ページのタイトルを確実に表示させる**
    - [x] `src/app/bots/page.tsx` を修正し、タイトルが必ず表示される構造にする。
- [x] **タスク1-3: カテゴリ分類の修正**
    - [x] 「学習」を「占い・スピ系」に変更する。
    - [x] 「揶揄・診断系」を「ビジネス系」に変更する。
    - [x] アイコンのマッピングも適切に更新する。

### フェーズ2：コア機能の回復

- [x] **タスク2-1: ヘッダーとマイページのAPIエラー修正**
    - [x] ログインしていない状態でもエラーにならないよう、`/api/account/points` を修正する。
    - [x] `/api/account/profile` のエラー原因を特定し、修正する。
- [x] **タスク2-2: チャット機能のAPIエラー修正**
    - [x] `/api/bot/use` のエラー原因を特定し、修正する。

### フェーズ3：デプロイ環境の修復

- [x] **タスク3-1: Vercelの環境変数を設定する**
    - [x] 必要な環境変数の一覧を提示する。
    - [x] Vercelの管理画面で設定する手順を案内する。
- [ ] **タスク3-2: 再デプロイと動作確認**
    - [ ] 最新の修正を反映させてVercelにデプロイする。
    - [ ] デプロイ環境で全機能が正常に動作することを確認する。

---
*この計画書は、進捗に応じて更新されます。*

