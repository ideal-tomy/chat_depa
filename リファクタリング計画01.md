# リファクタリング実行計画 v0.1

> ブランチ方式で段階的に進める完全リファクタリングのロードマップです。
> 期限目安 : 7 開発日    責任ブランチ : `refactor/phase1-core-cleanup`

---

## 📂 フェーズ0：準備（0.5 日）

| ✅ | タスク | コマンド／備考 |
|----|--------|----------------|
| [x] | **0-1. ブランチ作成** | `git checkout -b refactor/phase1-core-cleanup` |
| [x] | **0-2. ESLint & Prettier を強制** | `pnpm add -D eslint prettier eslint-config-next` → `.eslintrc` を strict に |
| [ ] | **0-3. Storybook/Playground 導入（任意）** | `pnpm dlx sb init` で UI 検証基盤 |

---

## 🔹 フェーズ1：アーキテクチャ再整備（1.5 日）

### 1-A. ディレクトリ構成 / 命名統一

- [ ] `src/components/` を Atomic Design（atoms / molecules / organisms）で再配置
- [ ] API ルートを機能別ツリー `account / admin / bot` へ整理

### 1-B. 型定義の集中管理

- [x] `src/types/index.ts` に共通型 (`Bot`/`User`/`Points` 等) を export
- [ ] `supabase gen types typescript --linked` を CI に組み込み

### 1-C. Supabase クライアント分離

- [x] `lib/supabase/browser.ts`（anon）と `server.ts`（service role）を分割
- [x] API ルートでは常に server クライアントを使用

---

## 🔹 フェーズ2：UI コンポーネント統一（2 日）

### 2-A. BotCard

- [x] props を `size` `variant` `hideForm` などに整理
- [x] `w-[320px] h-[380px]` で寸法固定
- [ ] Storybook で visual regression test

### 2-B. Carousel 一本化

- [x] `HorizontalCarousel` をベースに一本化（内部統合）
- [x] PickUpCarousel / CategoryCarousel を置き換え

### 2-C. CategorySection

- [x] ヘッダー + カルーセルを汎用化
- [x] Home と /bots 双方で再利用
- [x] タイトル欠落バグを解消

---

## 🔹 フェーズ3：API & 認証整理（1.5 日）

### 3-A. 動的 API ハンドラ統一

- [x] 全 app-route handler に `export const dynamic = 'force-dynamic'` を宣言
- [x] `api-client.ts` を **相対パス fetch 専用**に修正（CORS を根絶）

### 3-B. ポイント / プロフィール API 改修

- [x] 未ログイン時は HTTP 200 + デフォルト値を返却
- [ ] React Query でフェールセーフ取得

### 3-C. RLS & サービスキー

- [ ] サーバー側のみ `SUPABASE_SERVICE_ROLE_KEY` を利用
- [ ] .env.public から機密値を排除

---

## 🔹 フェーズ4：ページリファクタリング（1.5 日）

| ページ | 主な変更 | 目的 |
|--------|----------|------|
| `/` Top | Hero → CategorySection 羅列へ簡潔化 | SEO & パフォーマンス |
| `/bots` | SSR + Hydration、カテゴリ別タイトル表示 | タイトル欠落バグ修正 |
| `/account/mypage` | Suspense + ErrorBoundary で API エラー処理 | UX 安定 |

---

## 🔹 フェーズ5：ビルド & デプロイ整備（0.5 日）

- [x] `next.config.js` の `ignoreBuildErrors` を削除
- [x] GitHub Actions：`npm run lint && npm run build` で CI 実行
- [ ] `.env.preview` を用意して Vercel Preview を自動化

---

## ⚡ フェーズ6：QA & リリース（1 日）

- [ ] Playwright で Happy-Path E2E（ログイン / Bot 利用 / 購入フロー）
- [ ] レスポンシブ確認（375 / 768 / 1280）
- [ ] Lighthouse 90+ & a11y 90+ を達成
- [ ] main ブランチへマージ ➜ `vercel --prod`

---

## 🎯 完了条件（Definition of Done）

1. **カード幅・高さの完全統一**（ピックアップ / 一覧とも）
2. **マイページ CORS エラー 0 件**（3000/3001 問題解消）
3. **カテゴリタイトル欠落バグ修正**
4. **build 時 TypeScript & ESLint エラー 0**
5. **Vercel Production で全ページ 200 OK**

---

> 以上のチェックリストを順番に消化することで、現行の UI/UX バグを解消し、将来拡張に耐えるクリーンアーキテクチャへ移行します。
